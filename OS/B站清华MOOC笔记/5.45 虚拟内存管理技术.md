# 5.4/5 虚拟内存管理技术

[toc]

### 目标

* 覆盖技术需要程序员梳理逻辑结构，编写程序复杂；交换技术粒度太大所以处理器的开销比较大。
* 虚存技术:
    * 像覆盖技术一样，不是把程序的所有内容放在内存中，因而能够运行比当前的空闲内存空间更大的程序。但是由操作系统完成，不需要程序员设计。
    * 像交换技术一样，能够实现进行在内存与外存之间的交换，因而可以得到更多的空闲内存空间。但是做得更好，只对进程的部分内容进行交换。
* 程序的局部性：指程序在执行过程中的一个较短时期，所执行的指令地址和指令的操作数地址分别局限在一定区域
    * 时间局部性：一条指令的一次执行和下次执行，一个数据的一次访问和下次访问都集中在一个较短时间内。
    * 空间局部性：当前指令和邻近的几条指令，当前访问的数据和邻近的几个数据都集中在一个较小的区域内。

### 基本概念

* 可以在页式或者段式内存管理的基础上实现。在装入程序时，不必将其全部装入到内存，只需要将当前需要执行的部分页面或段装入内存，就可以让程序开始执行。
* 在程序执行过程中，如果需要执行的指令或者需要访问的数据不在内存中（缺页或者缺段），处理器会通知操作系统将需要的页或者段调入内存中，继续执行。
* 另一方面，操作系统将内存中暂时不适用的页面或者段调出保存在外存中，从而腾出更多空闲空间存放将要装入的程序及将要调入的页面或段。

### 基本特征

* 大的用户空间：通过物理内存与外存结合，提供给用户的虚拟内存空间通常大于实际的物理内存。
* 部分交换：与交换技术相比，粒度按页或者段，开销减少。
* 不连续性：物理内存分配的不连续性，虚拟地址空间使用的不连续性。

### 虚拟页式内存管理

在页式存储管理的基础上，增加请求调页和页面置换功能。

##### 基本思路

* 当一个用户程序要调入内存运行时，不是所有页面都装入内存，而只是装入部分页面，就可以启动程序运行。
* 在运行过程中，发现要运行的程序或者要访问的数据不在内存中，则向系统发出缺页中断请求，系统处理这个中断时，将外存中相应的页面调入内存，使得程序继续运行。（请求调页）
* 程序执行过程中，内存被占用越来越多，会将部分暂时不执行的程序/不访问的数据换出内存。（页面置换）

##### 页表表项

* 物理页帧号
* 为了进行虚拟内存管理的flags位：
    * 驻留位：表示该页在内存还是外存。为1，该页在内存中，有效可以使用；为0，表示该页在外存中，如果访问该页表项，产生缺页中断。
    * 保护位：表示运行对该页进行何种类型的访问。只读/读写/可执行
    * 修改位：表明此页是否被修改过（写过）。如果被修改过，则内存中数据和外存中数据不一致，进行页面置换的时候就需要将修改过的数据重新写回外存。1表示修改过。0表示没有修改过，置换时直接释放就行。
    * 访问位：如果该页面被访问过（读/写），则设置此位为1。用于页面置换算法（长久没有被访问的说明可应该置换去外存）。

##### 缺页中断

1. 如果内存中有空闲的物理页面，则分配一物理页帧f，然后转到第步；否则转到第2步
2. 通过置换算法选择一个要进行替换的物理页帧f，它所对应的逻辑页号为q，查看该页在内存期间有没有修改过，如果有则需要写回外存。
3. 对q所对应的页表项进行修改，将驻留位置为0（表明页q此时不在物理内存中）。
4. 将需要访问的页p装入到物理页帧f中。
5. 修改p的驻留位为1，将物理帧号置为f
6. 重新运行被中断的指令。

##### 后备存储

* 何处保存没有被映射的页
    * 能够简单识别在二级存储器中的页
    * 交换空间（磁盘或者文件）：特殊格式，用于存放未被映射的页面
* 概念：
    * 一个虚拟地址空间的页面可以映射到一个文件（二级存储中）中的某个位置
    * 代码段：映射到可执行二进制文件
    * 动态加载的共享库程序段：映射到动态调用的库文件
    * 其它段：可能被映射到交换文件（swap file），由OS开辟的空间

##### 虚拟内存性能

* 有效存储器访问时间 EAT = 访存时间 * 页表命中几率 + page fault处理时间 * page fault几率 *（1 + dirty page概率）
* page fault处理时间 ：指的是进行硬盘访问需要的时间； dirty page概率 页面置换时需要写入硬盘的概率